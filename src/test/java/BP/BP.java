package BP;

import org.junit.Assert;
import org.junit.Test;
import org.openqa.selenium.*;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.interactions.Actions;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;


public class BP {

    @Test
    public void AuthPage() throws InterruptedException, IOException {

        WebDriver driver;
        WebDriverWait wait;
       // System.setProperty("webdriver.chrome.driver", "C:\\Program Files\\chromedriver\\chromedriver.exe");
        driver = new ChromeDriver();
        wait = new WebDriverWait(driver, 300);
        driver.manage().window().maximize();
        driver.get("http://rumskapt273.open.ru/273/login");
        driver.findElement(By.xpath("//*[@id='UserName']")).sendKeys("5740894133");
        driver.findElement(By.xpath("//*[@id='Password']")).sendKeys("!Qwerty123");
        driver.findElement(By.xpath("//*[@id='widget0']/div//button")).click();
        wait.until(ExpectedConditions.presenceOfElementLocated(By.xpath("//*[@id='react-tabs-11']/div/div[1]/div[2]/div/div[2]/div/div/div/div/div/button/div")));
        driver.findElement(By.xpath("//*[@id='react-tabs-11']/div/div[1]/div[2]/div/div[2]/div/div/div/div/div/button/div")).click();
        wait.until(ExpectedConditions.presenceOfElementLocated(By.xpath("//*[@id='react-tabs-15']/div/div[2]/div[1]/div/div")));

        By by = By.xpath("//*[@id='react-tabs-15']/div/div[2]/div[1]/div/div");
        Actions actions = new Actions(driver);
        WebElement elem = driver.findElement(by);
        actions.moveToElement(elem);
        actions.perform();
        wait.until(ExpectedConditions.presenceOfElementLocated(By.xpath("//*[@id='react-tabs-15']/div/div[2]/div[1]/div/div")));
        driver.findElement(By.xpath("//*[@id='react-tabs-15']/div/div[2]/div[1]/div/div")).click();
        Thread.sleep(2000);
        driver.findElement(By.xpath("//*[@class='input-ui']")).click();
        driver.findElement(By.xpath("//*[@id='widget0']/div/div[2]/div[2]/div[2]/div/div[2]/div[1]/div[2]/div[1]/div/form/div[5]/div[1]/div/div/div/div/input")).sendKeys("100");
        driver.findElement(By.xpath("//*[@id='widget0']/div/div[2]/div[2]/div[2]/div/div[2]/div[1]/div[2]/div[1]/div/form/div[10]/div/button[1]/div")).click();
        wait.until(ExpectedConditions.presenceOfElementLocated(By.xpath("//*[@class='input-style']")));
        Thread.sleep(2000);
        driver.findElement(By.xpath("//*[@class='input-style']")).click();


        Calendar calendar = Calendar.getInstance();
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
        String date = sdf.format(calendar.getTime());

        String selectElem = driver.findElement(By.xpath("//*[@class='drawer__header']")).getText();

        driver.findElement(By.xpath("//*[@class='input-style']")).sendKeys(getStringWithSms("\\\\tibco2\\Tibco_Logs\\Test2\\Adapters\\MarketPlace\\Processes\\Out\\Notification\\Send.SMS_" + date + ".log", getText(selectElem).toString()));
        driver.findElement(By.xpath("//*[@class='step__checkbox step__checkbox_false']")).click();
        Thread.sleep(1000);
        driver.findElement(By.xpath("//*[text()='Подписать']")).click();

        wait.until(ExpectedConditions.presenceOfElementLocated(By.xpath("//*[text()='Спасибо!']")));
        String title = driver.findElement(By.xpath("//*[text()='Спасибо!']")).getText();
        System.out.println(title);
        Assert.assertTrue(title.equals("Спасибо!"));


        String title2 = driver.findElement(By.xpath("//*[text()=' Ваш платеж принят в обработку.']")).getText();
        System.out.println(title2);
        Assert.assertTrue(title2.equals("Ваш платеж принят в обработку."));

        Thread.sleep(1000);
        driver.findElement(By.xpath("//*[text()='Закрыть']")).click();

        List<WebElement> elements = driver.findElements(By.xpath("//*[@class='table-list__cell table-list__cell_status']/span"));

        String elem3 = elements.get(0).getAttribute("title");


        wait.until(ExpectedConditions.presenceOfElementLocated(By.xpath("(//*/td[@class='table-list__cell table-list__cell_status'])[1]/span[@class='account-item__status account-item__status_ok']")));
        Assert.assertTrue(elem3.equals("Выполнен"));


    }

    private String getText(String selectElem) {
        String exem = selectElem.substring(selectElem.indexOf("№")+1,selectElem.lastIndexOf(" от"));
        return exem.toString();
    }

    private String getStringWithSms(String smsLogFilePath, String number) throws IOException {
        StringBuilder result = new StringBuilder();

        byte[] fileBytes = Files.readAllBytes(Paths.get(smsLogFilePath));
        String fileContent = new String(fileBytes, "Windows-1251");

        List<String> allMatches = new ArrayList<String>();
        Matcher m = Pattern.compile("П/П\\s+N" + number + ".+:\\s+(?<code>\\d{4})")
                .matcher(fileContent);

        while (m.find()) {
            allMatches.add(m.group("code"));
        }

        if (!allMatches.isEmpty()) {
            result.append(allMatches.get(allMatches.size() - 1));
        }

        return result.toString();
    }
}